name: Deploy Classic App

on:
  workflow_dispatch:
    inputs:
      first_run:
        description: 'Is this the first run to create the base AMI?'
        required: true
        type: boolean
        default: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      # --- INFRASTRUCTURE DEPLOYMENT ---
      - name: Deploy Prerequisites
        run: |
          echo "Deploying Prerequisites at $(date)"
          STACK_STATUS=$(aws cloudformation describe-stacks --stack-name mini-prerequisites --query "Stacks[0].StackStatus" --output text 2>/dev/null) || STACK_STATUS="DOES_NOT_EXIST"
          if [ "$STACK_STATUS" == "ROLLBACK_COMPLETE" ]; then
            echo "Stack is in ROLLBACK_COMPLETE state. Deleting stack..."
            aws cloudformation delete-stack --stack-name mini-prerequisites
            aws cloudformation wait stack-delete-complete --stack-name mini-prerequisites
            echo "Stack deleted."
          fi
          aws cloudformation deploy --stack-name mini-prerequisites --template-file cloudformation/0-prerequisites.yml --no-fail-on-empty-changeset

      - name: Deploy Network
        run: |
          STACK_STATUS=$(aws cloudformation describe-stacks --stack-name mini-net --query "Stacks[0].StackStatus" --output text 2>/dev/null) || STACK_STATUS="DOES_NOT_EXIST"
          if [ "$STACK_STATUS" == "ROLLBACK_COMPLETE" ]; then
            echo "Stack is in ROLLBACK_COMPLETE state. Deleting stack..."
            aws cloudformation delete-stack --stack-name mini-net
            aws cloudformation wait stack-delete-complete --stack-name mini-net
            echo "Stack deleted."
          fi
          aws cloudformation deploy --stack-name mini-net --template-file cloudformation/1-vpc-network.yml

      - name: Deploy Security
        run: |
          STACK_STATUS=$(aws cloudformation describe-stacks --stack-name mini-sg --query "Stacks[0].StackStatus" --output text 2>/dev/null) || STACK_STATUS="DOES_NOT_EXIST"
          if [ "$STACK_STATUS" == "ROLLBACK_COMPLETE" ]; then
            echo "Stack is in ROLLBACK_COMPLETE state. Deleting stack..."
            aws cloudformation delete-stack --stack-name mini-sg
            aws cloudformation wait stack-delete-complete --stack-name mini-sg
            echo "Stack deleted."
          fi
          aws cloudformation deploy --stack-name mini-sg --template-file cloudformation/2-security-groups.yml

      - name: Deploy IAM Roles
        run: |
          STACK_STATUS=$(aws cloudformation describe-stacks --stack-name mini-iam --query "Stacks[0].StackStatus" --output text 2>/dev/null) || STACK_STATUS="DOES_NOT_EXIST"
          if [ "$STACK_STATUS" == "ROLLBACK_COMPLETE" ]; then
            echo "Stack is in ROLLBACK_COMPLETE state. Deleting stack..."
            aws cloudformation delete-stack --stack-name mini-iam
            aws cloudformation wait stack-delete-complete --stack-name mini-iam
            echo "Stack deleted."
          fi
          aws cloudformation deploy --stack-name mini-iam --template-file cloudformation/3-iam-roles.yml --capabilities CAPABILITY_NAMED_IAM

      - name: Get Latest AMI ID
        id: get-ami
        run: |
          AMI_ID=$(aws ssm get-parameter --name "/mini-ci-cd/latest-ami-id" --query "Parameter.Value" --output text 2>/dev/null) || AMI_ID="ami-045a8ab02aadf4f88" # Fallback to default if not set
          echo "AMI_ID=$AMI_ID" >> $GITHUB_ENV
          echo "The AMI ID is: $AMI_ID"

      - name: Deploy Compute
        run: |
          STACK_STATUS=$(aws cloudformation describe-stacks --stack-name mini-compute --query "Stacks[0].StackStatus" --output text 2>/dev/null) || STACK_STATUS="DOES_NOT_EXIST"
          if [ "$STACK_STATUS" == "ROLLBACK_COMPLETE" ]; then
            echo "Stack is in ROLLBACK_COMPLETE state. Deleting stack..."
            aws cloudformation delete-stack --stack-name mini-compute
            aws cloudformation wait stack-delete-complete --stack-name mini-compute
            echo "Stack deleted."
          fi
          aws cloudformation deploy --stack-name mini-compute \
          --template-file cloudformation/4-compute.yml \
          --parameter-overrides KeyName=mini-project-key FirstRun=${{ github.event.inputs.first_run }} DBRootPassword=${{ secrets.DB_ROOT_PASSWORD }} WebAppAmiId=${{ env.AMI_ID }}

      # --- GET IPS FOR DEPLOYMENT ---
      - name: Get Infrastructure IPs
        id: get-ip
        run: |
          WEB_IP=$(aws cloudformation describe-stacks --stack-name mini-compute --query "Stacks[0].Outputs[?OutputKey=='WebAppIP'].OutputValue" --output text)
          DB_IP=$(aws cloudformation describe-stacks --stack-name mini-compute --query "Stacks[0].Outputs[?OutputKey=='DBPrivateIP'].OutputValue" --output text)
          echo "WEB_IP=$WEB_IP" >> $GITHUB_ENV
          echo "DB_IP=$DB_IP" >> $GITHUB_ENV

      # --- APP DEPLOYMENT (Classic SSH with Fixes) ---
      - name: Deploy Code via SSH
        uses: appleboy/ssh-action@v1.0.0
        env:
          # Map secrets to env vars so we can pass them to the script
          SSH_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          DB_USER: ${{ secrets.DATABASE_USERNAME }}
          DB_PASS: ${{ secrets.DATABASE_PASSWORD }}
          DB_NAME: ${{ secrets.DATABASE_NAME }}
          DB_IP: ${{ env.DB_IP }}
        with:
          host: ${{ env.WEB_IP }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          # Pass env vars to the remote server
          envs: SSH_KEY,SECRET_KEY,DB_USER,DB_PASS,DB_NAME,DB_IP
          script: |
            # --- 1. SETUP ENV & DEPENDENCIES ---
            sudo apt-get update
            sudo apt-get install -y python3-venv mysql-client nginx
            
            # Create App Directory & Set Initial Permissions
            sudo mkdir -p /home/ubuntu/mini-ci-cd-project
            sudo chown ubuntu:ubuntu /home/ubuntu/mini-ci-cd-project
            cd /home/ubuntu/mini-ci-cd-project

            # --- 2. CLONE & INSTALL APP ---
            if [ ! -d ".git" ]; then
              git clone https://github.com/${{ github.repository }}.git .
            else
              git fetch --all --prune
              git reset --hard origin/main
            fi

            # Setup Python Venv
            if [ ! -d "venv" ]; then python3 -m venv venv; fi
            source venv/bin/activate
            pip install -r backend/requirements.txt

            # Write .env file
            echo "SECRET_KEY=$SECRET_KEY" > backend/.env
            echo "DATABASE_HOST=$DB_IP" >> backend/.env
            echo "DATABASE_USERNAME=$DB_USER" >> backend/.env
            echo "DATABASE_PASSWORD=$DB_PASS" >> backend/.env
            echo "DATABASE_NAME=$DB_NAME" >> backend/.env

            # --- 3. AUTOMATED DB PERMISSION FIX (The Jump Strategy) ---
            echo "Fixing DB Permissions on host $DB_IP..."
            # Create temporary key
            echo "$SSH_KEY" > /home/ubuntu/temp_key.pem
            chmod 600 /home/ubuntu/temp_key.pem
            
            # SSH into DB Server and run Grants (Runs as ROOT on DB via sudo)
            ssh -o StrictHostKeyChecking=no -i /home/ubuntu/temp_key.pem ubuntu@$DB_IP \
              "sudo mysql -e \"CREATE USER IF NOT EXISTS '$DB_USER'@'%' IDENTIFIED BY '$DB_PASS'; GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'%'; FLUSH PRIVILEGES;\""
            
            # Cleanup key
            rm /home/ubuntu/temp_key.pem
            echo "DB Permissions Fixed."

            # --- 4. CONFIGURE SERVICES ---
            sudo cp backend/deploy/app.service /etc/systemd/system/
            sudo cp backend/deploy/nginx_app.conf /etc/nginx/sites-available/app
            sudo ln -sf /etc/nginx/sites-available/app /etc/nginx/sites-enabled/app
            sudo rm -f /etc/nginx/sites-enabled/default

            # --- 5. FIX NGINX PERMISSIONS (The 502 Fix) ---
            # Give Nginx (www-data) access to the files
            sudo chown -R ubuntu:www-data /home/ubuntu/mini-ci-cd-project
            sudo chmod -R 775 /home/ubuntu/mini-ci-cd-project
            # Allow Nginx to traverse the home directory
            sudo chmod 755 /home/ubuntu

            # --- 6. RESTART ---
            sudo systemctl daemon-reload
            sudo systemctl enable app
            sudo systemctl restart app
            sudo systemctl restart nginx

      # --- BAKE AMI ---
      - name: Bake AMI
        if: github.event.inputs.first_run == 'true'
        run: |
          echo "Baking new AMI..."
          WEB_APP_ID=$(aws cloudformation describe-stacks --stack-name mini-compute --query "Stacks[0].Outputs[?OutputKey=='WebAppId'].OutputValue" --output text)
          IMAGE_NAME="mini-ci-cd-golden-ami-$(date +%Y-%m-%d-%H-%M-%S)"
          IMAGE_ID=$(aws ec2 create-image --instance-id $WEB_APP_ID --name "$IMAGE_NAME" --query "ImageId" --output text)
          echo "Waiting for AMI $IMAGE_ID to be available..."
          aws ec2 wait image-available --image-ids $IMAGE_ID
          echo "AMI $IMAGE_ID is available."
          aws ssm put-parameter --name "/mini-ci-cd/latest-ami-id" --value $IMAGE_ID --type "String" --overwrite --region us-east-1
          echo "SSM parameter /mini-ci-cd/latest-ami-id updated with new AMI ID: $IMAGE_ID"